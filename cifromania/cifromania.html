<!doctype html>
<html lang="bg">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>1234 | –¶–∏—Ñ—Ä–æ–º–∞–Ω–∏—è </title>

<style>
* { margin:0; padding:0; box-sizing:border-box; }

body {
  font-family: 'Segoe UI', Arial, sans-serif;
  background: #00264d;
  color: #fff;
  max-width: 900px;
  margin: 0 auto;
  padding: 20px;
  text-align: center;
}

h1 {
  color: #ffd100;
  margin-bottom: 20px;
}

.card {
  background: rgba(255,255,255,0.06);
  padding: 20px;
  border-radius: 16px;
  max-width: 600px;
  margin: 0 auto;
}

input {
  padding: 12px;
  font-size: 1.2em;
  border-radius: 8px;
  border: none;
  width: 80%;
  text-align: center;
}

button {
  margin-top: 15px;
  padding: 12px 24px;
  font-size: 1.1em;
  border-radius: 8px;
  border: none;
  background: #ffd100;
  font-weight: bold;
  cursor: pointer;
}

#timer {
  font-size: 2.4em;
  margin: 15px 0;
  color: #ffeb3b;
  font-weight: bold;
}

#timer.danger {
  color: #ff5252;
}

#question {
  font-size: 1.4em;
  margin: 20px 0;
}

#feedback {
  margin-top: 15px;
  font-size: 1.1em;
}

#score {
  margin-top: 10px;
  font-size: 1.2em;
  color: #ffd100;
}

  .correct-answer {
  color: #00ff88;
  font-weight: bold;
}
</style>
</head>

<body>

<h1>üî¢ –¶–∏—Ñ—Ä–æ–º–∞–Ω–∏—è üî¢</h1>

<div id="start-screen" class="card">
  <p>–í—ä–≤–µ–¥–∏ ID-–Ω–æ–º–µ—Ä–∞ —Å–∏:</p>
  <input id="playerId" placeholder="–í—ä–≤–µ–¥–∏ ID">
  <br>
  <button id="startBtn">–ó–∞–ø–æ—á–Ω–∏</button>
</div>

<div id="game" class="card" style="display:none;">
  <div id="timer">20</div>
  <div id="question"></div>

  <input type="number" id="answerInput" placeholder="–í—ä–≤–µ–¥–∏ —á–∏—Å–ª–æ">
  <br>
  <button id="submitBtn">–û—Ç–≥–æ–≤–æ—Ä–∏</button>

  <div id="feedback"></div>
  <div id="score">–¢–æ—á–∫–∏: 0</div>
</div>

  <script src="players.js"></script>
<script>
(async function(){

/* ====== –ù–ê–°–¢–†–û–ô–ö–ò –ù–ê –í–†–ï–ú–ï–¢–û ====== */
const GAME_START_HOUR = 14;
const GAME_START_MIN = 50;
const GAME_END_HOUR   = 23;
const GAME_END_MIN    = 0;

/* ====== DOM ====== */
const startScreen = document.getElementById("start-screen");
const game = document.getElementById("game");
const startBtn = document.getElementById("startBtn");
  const idInput = document.getElementById("playerId");
const nameInput = document.getElementById("playerName");
const timerDiv = document.getElementById("timer");
const qText = document.getElementById("question");
const ansInput = document.getElementById("answerInput");
const submitBtn = document.getElementById("submitBtn");
const feedback = document.getElementById("feedback");
const scoreDiv = document.getElementById("score");

/* ====== STATE ====== */
let allQuestions = [];
let questions = [];
let idx = 0;
let score = 0;
let timer;
let timeLeft = 20;
let playerName = "";

/* ====== –í–†–ï–ú–ï–í–ò –ü–†–û–ó–û–†–ï–¶ ====== */
function isGameOpenNow(){
  const now = new Date();

  const start = new Date();
  start.setHours(GAME_START_HOUR, GAME_START_MIN, 0, 0);

  const end = new Date();
  end.setHours(GAME_END_HOUR, GAME_END_MIN, 0, 0);

  return now >= start && now < end;
}

function msUntilGameEnds(){
  const now = new Date();
  const end = new Date();
  end.setHours(GAME_END_HOUR, GAME_END_MIN, 0, 0);
  return end - now;
}

/* ====== LOAD JSON ====== */
const res = await fetch("./questions.json");
allQuestions = await res.json();

/* ====== RANDOM 20 ====== */
function pickRandom(n){
  return [...allQuestions].sort(()=>Math.random()-0.5).slice(0,n);
}

/* ====== TIMER ====== */
function startTimer(){
  clearInterval(timer);
  timeLeft = 20;
  timerDiv.textContent = timeLeft;
  timerDiv.classList.remove("danger");

  timer = setInterval(()=>{
    timeLeft--;
    timerDiv.textContent = timeLeft;
    if(timeLeft <= 5) timerDiv.classList.add("danger");
    if(timeLeft <= 0){
      clearInterval(timer);
      submitAnswer(true);
    }
  },1000);
}

/* ====== –¢–û–ß–ö–£–í–ê–ù–ï (–î–ò–ê–ü–ê–ó–û–ù–ò) ====== */
function calcPoints(diff, q){
  const r = q.ranges;

  if (diff === 0) return 10;
  if (r && diff <= r.near) return 5;
  if (r && diff <= r.mid)  return 3;
  if (r && diff <= r.far)  return 1;

  return 0;
}
/* ====== –í–™–ü–†–û–° ====== */
function renderQuestion(){
  const q = questions[idx];
  qText.textContent = `${idx+1}. ${q.question}`;
  ansInput.value = "";
  ansInput.focus();
  feedback.textContent = "";
  scoreDiv.textContent = `–¢–æ—á–∫–∏: ${score}`;
  startTimer();
}

/* ====== –û–¢–ì–û–í–û–† ====== */
function submitAnswer(timeout=false){
  clearInterval(timer);

  const q = questions[idx];
  const correct = Number(q.answer);
  const user = timeout ? null : Number(ansInput.value);

  const diff = user === null || isNaN(user)
    ? Infinity
    : Math.abs(user - correct);

  const pts = calcPoints(diff, q);
  score += pts;

  if(timeout){
  feedback.textContent =
    `‚è∞ –í—Ä–µ–º–µ—Ç–æ –∏–∑—Ç–µ—á–µ! –í–µ—Ä–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä: ${correct}`;
} else {
 feedback.innerHTML =
  `<span class="correct-answer">‚úî –í–µ—Ä–µ–Ω: ${correct}</span> | –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ: ${diff} ‚Üí ${pts} —Ç–æ—á–∫–∏`;
}

  scoreDiv.textContent = `–¢–æ—á–∫–∏: ${score}`;

  setTimeout(()=>{
    idx++;
    if(idx >= questions.length){
      endGame();
    } else {
      renderQuestion();
    }
  }, 5000); // ‚¨ÖÔ∏è 5 —Å–µ–∫—É–Ω–¥–∏
}

/* ====== –ö–†–ê–ô ====== */
function endGame(){
  clearInterval(timer);
  qText.innerHTML = `üèÅ <b>${playerName}</b>, –∑–∞–≤—ä—Ä—à–∏ —Å <b>${score}</b> —Ç–æ—á–∫–∏`;
  timerDiv.textContent = "";
  ansInput.style.display = "none";
  submitBtn.style.display = "none";
}

/* ====== EVENTS ====== */
submitBtn.onclick = () => submitAnswer(false);
ansInput.addEventListener("keydown", e => {
  if(e.key === "Enter") submitAnswer(false);
});

startBtn.onclick = () => {
  const id = idInput.value.trim();

  if (!PLAYERS[id]) {
    alert("‚ùå –ù–µ–≤–∞–ª–∏–¥–Ω–æ ID");
    return;
  }

  if(!isGameOpenNow()){
    alert("‚ùå –¶–∏—Ñ—Ä–æ–º–∞–Ω–∏—è –µ –æ—Ç–∫–ª—é—á–µ–Ω–∞ –≤—Å–µ–∫–∏ –¥–µ–Ω –æ—Ç 19:50 –¥–æ 20:00");
    return;
  }

  playerName = PLAYERS[id];

  startScreen.style.display = "none";
  game.style.display = "block";

  questions = pickRandom(20);
  idx = 0;
  score = 0;

  renderQuestion();

  setTimeout(endGame, msUntilGameEnds());
};

})();
</script>

</body>
</html>
