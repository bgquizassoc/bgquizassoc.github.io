<!doctype html>
<html lang="bg">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–¶–∏—Ñ—Ä–æ–º–∞–Ω–∏—è</title>

<style>
body {
  font-family: Arial, sans-serif;
  background: #00264d;
  color: #fff;
  max-width: 900px;
  margin: 0 auto;
  padding: 20px;
  text-align: center;
}
.card {
  background: rgba(255,255,255,0.08);
  padding: 20px;
  border-radius: 14px;
  max-width: 600px;
  margin: 20px auto;
}
input, button {
  padding: 12px;
  font-size: 1.1em;
  border-radius: 8px;
  border: none;
  margin-top: 10px;
}
button {
  background: #ffd100;
  font-weight: bold;
  cursor: pointer;
}
#timer {
  font-size: 2em;
  color: #ffd100;
}
#timer.danger { color: #ff5252; }
.correct { color: #00ff88; }
</style>
</head>

<body>

<h1>üî¢ –¶–∏—Ñ—Ä–æ–º–∞–Ω–∏—è</h1>

<div id="start-screen" class="card">
  <p>–í—ä–≤–µ–¥–∏ ID:</p>
  <input id="playerId" placeholder="ID">
  <br>
  <button id="startBtn">–ó–∞–ø–æ—á–Ω–∏</button>
</div>

<div id="game" class="card" style="display:none">
  <div id="timer">20</div>
  <div id="question"></div>
  <input id="answerInput" type="number" placeholder="–û—Ç–≥–æ–≤–æ—Ä">
  <br>
  <button id="submitBtn">–û—Ç–≥–æ–≤–æ—Ä–∏</button>
  <div id="feedback"></div>
  <div id="score">–¢–æ—á–∫–∏: 0</div>
</div>

<div id="leaderboard" class="card" style="display:none">
  <h2>–ö–ª–∞—Å–∞—Ü–∏—è (–¢–û–ü 5)</h2>
  <ol id="leaderboard-list"></ol>
</div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import {
  getFirestore, doc, setDoc,
  collection, query, where, orderBy, limit, onSnapshot
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB6ds9mU-xvF1LSvhaeCNtMbROu0k",
  authDomain: "cifromania-ac182.firebaseapp.com",
  projectId: "cifromania-ac182"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

window.db = db;
window.fs = { doc, setDoc, collection, query, where, orderBy, limit, onSnapshot };
</script>

<script src="players.js"></script>

<script>
(async function(){

let questions = [];
let idx = 0;
let score = 0;
let timer;
let timeLeft = 20;
let playerId = "";
let playerName = "";

const startScreen = document.getElementById("start-screen");
const game = document.getElementById("game");
const qText = document.getElementById("question");
const timerDiv = document.getElementById("timer");
const ansInput = document.getElementById("answerInput");
const feedback = document.getElementById("feedback");
const scoreDiv = document.getElementById("score");

const res = await fetch("questions.json");
const allQuestions = await res.json();

function shuffle(arr){
  return [...arr].sort(()=>Math.random()-0.5);
}

function startTimer(){
  clearInterval(timer);
  timeLeft = 20;
  timerDiv.textContent = timeLeft;
  timerDiv.classList.remove("danger");

  timer = setInterval(()=>{
    timeLeft--;
    timerDiv.textContent = timeLeft;
    if(timeLeft <= 5) timerDiv.classList.add("danger");
    if(timeLeft <= 0){
      clearInterval(timer);
      submitAnswer(true);
    }
  },1000);
}

function calcPoints(diff, q){
  if(diff === 0) return 10;
  if(diff <= q.ranges.near) return 5;
  if(diff <= q.ranges.mid) return 3;
  if(diff <= q.ranges.far) return 1;
  return 0;
}

function renderQuestion(){
  const q = questions[idx];
  qText.textContent = `${idx+1}. ${q.question}`;
  ansInput.value = "";
  feedback.textContent = "";
  scoreDiv.textContent = `–¢–æ—á–∫–∏: ${score}`;
  startTimer();
}

function submitAnswer(timeout=false){
  clearInterval(timer);
  const q = questions[idx];
  const correct = Number(q.answer);
  const user = timeout ? null : Number(ansInput.value);
  const diff = user === null || isNaN(user) ? Infinity : Math.abs(user - correct);
  const pts = calcPoints(diff, q);
  score += pts;

  feedback.innerHTML = timeout
    ? `‚è∞ –í—Ä–µ–º–µ—Ç–æ –∏–∑—Ç–µ—á–µ. –í–µ—Ä–µ–Ω: <b>${correct}</b>`
    : `<span class="correct">‚úî ${correct}</span> | +${pts} —Ç.`;

  scoreDiv.textContent = `–¢–æ—á–∫–∏: ${score}`;

  setTimeout(()=>{
    idx++;
    if(idx >= questions.length){
      endGame();
    } else {
      renderQuestion();
    }
  }, 3000);
}

async function endGame(){
  clearInterval(timer);

  try {
    const today = new Date().toISOString().split("T")[0];
    await fs.setDoc(
      fs.doc(db, "results", `${today}_${playerId}`),
      { userId: playerId, name: playerName, score, gameId: today, ts: Date.now() }
    );
  } catch(e){
    console.error("Firestore error", e);
  }

  qText.innerHTML = `<b>${playerName}</b> –∑–∞–≤—ä—Ä—à–∏ —Å <b>${score}</b> —Ç–æ—á–∫–∏`;
  document.getElementById("submitBtn").style.display = "none";
  ansInput.style.display = "none";

  startLeaderboard();
}

function startLeaderboard(){
  const today = new Date().toISOString().split("T")[0];
  const q = fs.query(
    fs.collection(db, "results"),
    fs.where("gameId","==",today),
    fs.orderBy("score","desc"),
    fs.limit(5)
  );

  fs.onSnapshot(q, snap=>{
    const list = document.getElementById("leaderboard-list");
    list.innerHTML = "";
    snap.forEach(d=>{
      const li = document.createElement("li");
      li.textContent = `${d.data().name} ‚Äî ${d.data().score}`;
      list.appendChild(li);
    });
    document.getElementById("leaderboard").style.display="block";
  });
}

document.getElementById("submitBtn").onclick = ()=>submitAnswer(false);
ansInput.addEventListener("keydown",e=>{
  if(e.key==="Enter") submitAnswer(false);
});

document.getElementById("startBtn").onclick = ()=>{
  const id = document.getElementById("playerId").value.trim();
  if(!PLAYERS[id]) return alert("–ù–µ–≤–∞–ª–∏–¥–Ω–æ ID");

  playerId = id;
  playerName = PLAYERS[id];

  questions = shuffle(allQuestions).slice(0,10);
  idx = 0;
  score = 0;

  startScreen.style.display="none";
  game.style.display="block";
  renderQuestion();
};

})();
</script>

</body>
</html>
