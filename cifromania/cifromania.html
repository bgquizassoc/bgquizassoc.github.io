<!doctype html>
<html lang="bg">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>1234 | –¶–∏—Ñ—Ä–æ–º–∞–Ω–∏—è </title>

<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-PK66NTHPN8"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-PK66NTHPN8');
</script>

<style>
* { margin:0; padding:0; box-sizing:border-box; }

body {
  font-family: 'Segoe UI', Arial, sans-serif;
  background: #00264d;
  color: #fff;
  max-width: 900px;
  margin: 0 auto;
  padding: 20px;
  text-align: center;
}

h1 {
  color: #ffd100;
  margin-bottom: 20px;
}

.card {
  background: rgba(255,255,255,0.06);
  padding: 20px;
  border-radius: 16px;
  max-width: 600px;
  margin: 0 auto;
}

input {
  padding: 12px;
  font-size: 1.2em;
  border-radius: 8px;
  border: none;
  width: 80%;
  text-align: center;
}

button {
  margin-top: 15px;
  padding: 12px 24px;
  font-size: 1.1em;
  border-radius: 8px;
  border: none;
  background: #ffd100;
  font-weight: bold;
  cursor: pointer;
}

#timer {
  font-size: 2.4em;
  margin: 15px 0;
  color: #ffeb3b;
  font-weight: bold;
}

#timer.danger {
  color: #ff5252;
}

#question {
  font-size: 1.4em;
  margin: 20px 0;
}

#feedback {
  margin-top: 15px;
  font-size: 1.1em;
}

#score {
  margin-top: 10px;
  font-size: 1.2em;
  color: #ffd100;
}

.correct-answer {
  color: #00ff88;
  font-weight: bold;
}

/* ===== –ö–õ–ê–°–ê–¶–ò–Ø ===== */
#leaderboard {
  margin-top: 25px;
  padding: 15px;
  background: rgba(255,255,255,0.08);
  border-radius: 12px;
}

#leaderboard h2 {
  margin-bottom: 10px;
  color: #ffd100;
}

#leaderboard-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

#leaderboard-list li {
  padding: 6px 0;
  border-bottom: 1px solid rgba(255,255,255,0.15);
}
</style>
</head>

<body>

<audio id="bg-music" src="music.mp3" loop preload="auto"></audio>

<h1>üî¢ –¶–∏—Ñ—Ä–æ–º–∞–Ω–∏—è üî¢</h1>

<!-- ===== –°–¢–ê–†–¢ –ï–ö–†–ê–ù ===== -->
<div id="start-screen" class="card">
  <p>–í—ä–≤–µ–¥–∏ ID-–Ω–æ–º–µ—Ä–∞ —Å–∏:</p>
  <input id="playerId" placeholder="–í—ä–≤–µ–¥–∏ ID">
  <br>
  <button id="startBtn">–ó–∞–ø–æ—á–Ω–∏</button>
</div>

<!-- ===== –ò–ì–†–ê ===== -->
<div id="game" class="card" style="display:none;">
  <div id="timer">20</div>
  <div id="question"></div>

  <input type="number" id="answerInput" placeholder="–í—ä–≤–µ–¥–∏ —á–∏—Å–ª–æ">
  <br>
  <button id="submitBtn">–û—Ç–≥–æ–≤–æ—Ä–∏</button>

  <div id="feedback"></div>
  <div id="score">–¢–æ—á–∫–∏: 0</div>
</div>

<!-- ===== –ö–õ–ê–°–ê–¶–ò–Ø ===== -->
<div id="leaderboard" class="card" style="display:none;">
  <h2>–ö–ª–∞—Å–∞—Ü–∏—è</h2>
  <ol id="leaderboard-list"></ol>
</div>

<!-- ===== FIREBASE SDK ===== -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import { 
    getFirestore, 
    doc, 
    setDoc,
    getDoc,
    collection,
    query,
    where,
    orderBy,
    limit,
    onSnapshot
  } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyB6ds9mU-xvF1LSvhaeCNtMbROu0k",
    authDomain: "cifromania-ac182.firebaseapp.com",
    projectId: "cifromania-ac182",
    storageBucket: "cifromania-ac182.appspot.com",
    messagingSenderId: "165208255580",
    appId: "1:165208255580:web:b36744f0eb527b6571129"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  window.db = db;
  window.doc = doc;
  window.setDoc = setDoc;
  window.getDoc = getDoc;
  window.collection = collection;
  window.query = query;
  window.where = where;
  window.orderBy = orderBy;
  window.limit = limit;
  window.onSnapshot = onSnapshot;
</script>

<script src="players.js"></script>

<script>
(async function(){

/* ====== –ù–ê–°–¢–†–û–ô–ö–ò –ù–ê –í–†–ï–ú–ï–¢–û ====== */
const GAME_START_HOUR = 17;
const GAME_START_MIN = 40;
const GAME_END_HOUR   = 23;
const GAME_END_MIN    = 50;

/* ====== DOM ====== */
const startScreen = document.getElementById("start-screen");
const game = document.getElementById("game");
const startBtn = document.getElementById("startBtn");
const idInput = document.getElementById("playerId");
const timerDiv = document.getElementById("timer");
const qText = document.getElementById("question");
const ansInput = document.getElementById("answerInput");
const submitBtn = document.getElementById("submitBtn");
const feedback = document.getElementById("feedback");
const scoreDiv = document.getElementById("score");

const leaderboardDiv = document.getElementById("leaderboard");
const leaderboardList = document.getElementById("leaderboard-list");

/* ====== STATE ====== */
let allQuestions = [];
let questions = [];
let idx = 0;
let score = 0;
let timer;
let timeLeft = 20;
let playerName = "";

/* ====== LOAD JSON ====== */
const res = await fetch("./questions.json");
allQuestions = await res.json();

/* ====== RANDOM ====== */
function pickRandom(n){
  return [...allQuestions].sort(()=>Math.random()-0.5).slice(0,n);
}

/* ====== TIME WINDOW ====== */
function isGameOpenNow(){
  const now = new Date();
  const start = new Date();
  start.setHours(GAME_START_HOUR, GAME_START_MIN,0,0);
  const end = new Date();
  end.setHours(GAME_END_HOUR, GAME_END_MIN,0,0);
  return now>=start && now<end;
}

function msUntilGameEnds(){
  const now = new Date();
  const end = new Date();
  end.setHours(GAME_END_HOUR,GAME_END_MIN,0,0);
  return end-now;
}

/* ====== TIMER ====== */
function startTimer(){
  clearInterval(timer);
  timeLeft=20;
  timerDiv.textContent=timeLeft;
  timerDiv.classList.remove("danger");

  timer=setInterval(()=>{
    timeLeft--;
    timerDiv.textContent=timeLeft;
    if(timeLeft<=5) timerDiv.classList.add("danger");
    if(timeLeft<=0){
      clearInterval(timer);
      submitAnswer(true);
    }
  },1000);
}

/* ====== POINTS ====== */
function calcPoints(diff,q){
  const r=q.ranges;
  if(diff===0) return 10;
  if(r && diff<=r.near) return 5;
  if(r && diff<=r.mid) return 3;
  if(r && diff<=r.far) return 1;
  return 0;
}

/* ====== QUESTION ====== */
function renderQuestion(){
  const q=questions[idx];
  qText.textContent=`${idx+1}. ${q.question}`;
  ansInput.value="";
  ansInput.focus();
  feedback.textContent="";
  scoreDiv.textContent=`–¢–æ—á–∫–∏: ${score}`;
  startTimer();
}

/* ====== ANSWER ====== */
function submitAnswer(timeout=false){
  clearInterval(timer);

  const q=questions[idx];
  const correct=Number(q.answer);
  const user=timeout?null:Number(ansInput.value);

  const diff=user===null||isNaN(user)
    ?Infinity
    :Math.abs(user-correct);

  const pts=calcPoints(diff,q);
  score+=pts;

  if(timeout){
    feedback.innerHTML=`‚è∞ –í—Ä–µ–º–µ—Ç–æ –∏–∑—Ç–µ—á–µ! <span class="correct-answer">‚úî –í–µ—Ä–µ–Ω: ${correct}</span>`;
  }else{
    feedback.innerHTML=`<span class="correct-answer">‚úî –í–µ—Ä–µ–Ω: ${correct}</span> | –û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ: ${diff} ‚Üí ${pts} —Ç–æ—á–∫–∏`;
  }

  scoreDiv.textContent=`–¢–æ—á–∫–∏: ${score}`;

  setTimeout(()=>{
    idx++;
    if(idx>=questions.length){
      endGame();
    }else{
      renderQuestion();
    }
  },5000);
}

/* ====== –¢–û–ü 5 ====== */
function startLeaderboard(){
  const today=new Date().toISOString().split("T")[0];

  const q=window.query(
    window.collection(window.db,"results"),
    window.where("gameId","==",today),
    window.orderBy("score","desc"),
    window.limit(5)
  );

  window.onSnapshot(q,(snap)=>{
    leaderboardList.innerHTML="";
    snap.forEach(docSnap=>{
      const d=docSnap.data();
      const li=document.createElement("li");
      li.textContent=`${d.name||d.userId} ‚Äî ${d.score} —Ç.`;
      leaderboardList.appendChild(li);
    });
    leaderboardDiv.style.display="block";
  });
}

/* ====== –ü–™–õ–ù–ê –ö–õ–ê–°–ê–¶–ò–Ø ====== */
function startFullLeaderboard(){
  const today=new Date().toISOString().split("T")[0];

  const q=window.query(
    window.collection(window.db,"results"),
    window.where("gameId","==",today),
    window.orderBy("score","desc")
  );

  window.onSnapshot(q,(snap)=>{
    leaderboardList.innerHTML="";
    snap.forEach(docSnap=>{
      const d=docSnap.data();
      const li=document.createElement("li");
      li.textContent=`${d.name||d.userId} ‚Äî ${d.score} —Ç.`;
      leaderboardList.appendChild(li);
    });
    leaderboardDiv.style.display="block";
  });
}

/* ====== END GAME ====== */
async function endGame(){
  clearInterval(timer);

  const today=new Date().toISOString().split("T")[0];
  const userId=idInput.value.trim();

  try{
    await window.setDoc(
      window.doc(window.db,"results",`${today}_${userId}`),
      {
        userId:userId,
        name:playerName,
        score:score,
        gameId:today,
        timestamp:Date.now()
      }
    );
  }catch(e){
    console.error("‚ùå Firebase error:",e);
  }

  qText.innerHTML=`üèÅ <b>${playerName}</b>, –∑–∞–≤—ä—Ä—à–∏ —Å <b>${score}</b> —Ç–æ—á–∫–∏`;
  timerDiv.textContent="";
  ansInput.style.display="none";
  submitBtn.style.display="none";

  startFullLeaderboard();
}

/* ====== EVENTS ====== */
submitBtn.onclick=()=>submitAnswer(false);
ansInput.addEventListener("keydown",e=>{
  if(e.key==="Enter") submitAnswer(false);
});

startBtn.onclick=async ()=>{

  const id=idInput.value.trim();

  if(!PLAYERS[id]){
    alert("‚ùå –ù–µ–≤–∞–ª–∏–¥–Ω–æ ID");
    return;
  }

  if(!isGameOpenNow()){
    alert("‚ùå –¶–∏—Ñ—Ä–æ–º–∞–Ω–∏—è –µ –æ—Ç–∫–ª—é—á–µ–Ω–∞ –æ—Ç 19.40 –¥–æ 20.00 —á–∞—Å–∞");
    return;
  }

  const today = new Date().toISOString().split("T")[0];
  const docRef = window.doc(window.db, "results", `${today}_${id}`);
  const existing = await window.getDoc(docRef);

  if (existing.exists()) {
    alert("–í–µ—á–µ —Å–∏ –∏–≥—Ä–∞–ª –¥–Ω–µ—Å! –í–∏–∂ –∫–ª–∞—Å–∞—Ü–∏—è—Ç–∞.");
    startFullLeaderboard();
    startScreen.style.display = "none";
    game.style.display = "none";
    return;
  }

  playerName=PLAYERS[id];

  const bgMusic=document.getElementById("bg-music");
  bgMusic.play().catch(()=>{});

  startScreen.style.display="none";
  game.style.display="block";

  startLeaderboard(); // –¢–û–ü 5 –ø–æ –≤—Ä–µ–º–µ –Ω–∞ –∏–≥—Ä–∞

  questions=pickRandom(50);
  idx=0;
  score=0;

  renderQuestion();

  setTimeout(endGame,msUntilGameEnds());
};

})();
</script>

</body>
</html>
