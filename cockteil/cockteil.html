<!doctype html>
<html lang="bg">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>–ò–≥—Ä–∏ –Ω–∞ –ó–Ω–∞–Ω–∏—è - –ö—É–∏–∑ –ö–æ–∫—Ç–µ–π–ª</title>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; overflow-x: hidden; overflow-y: auto; }

    body {
      display: flex; flex-direction: column;
      align-items: center; justify-content: flex-start;
      font-size: 18px; font-family: 'Segoe UI', Arial, sans-serif;
      max-width: 900px; margin: 0 auto; padding: 20px;
      background: #00264d;
      color: #ffffff;
    }

    h1 {
      text-align: center; color: #ffd100;
      font-size: clamp(1.5em, 4vw, 2em);
      margin: 10px auto 15px auto;
      text-shadow: 0 0 5px #ffb400;
    }

    #quiz, #start-screen {
      width: 100%; max-width: 600px; text-align: center;
      margin-top: 30px;
      background: rgba(255,255,255,0.05);
      border-radius: 16px; padding: 20px;
      box-shadow: 0 0 10px rgba(255,209,0,0.2);
    }

    #question { font-size: 1.6em; margin: 20px 0; font-weight: 600; }

    .answers button {
      display: block; width: 100%; margin: 10px 0; padding: 16px;
      border: none; border-radius: 10px; cursor: pointer;
      font-size: 1.2em; background: #333; color: #fff;
      transition: 0.2s;
    }

    .answers button:hover { background: #444; transform: scale(1.02); }
    .answers button.correct { background: #2e7d32; }
    .answers button.wrong { background: #b71c1c; }

    #timer {
      text-align: center; font-weight: 800; margin: 20px 0;
      font-size: clamp(1.8em, 5vw, 2.6em);
      color: #ffeb3b; text-shadow: 0 0 12px #ffcc00;
    }
    #timer.warning { color: #ff4c4c; }

    #status { margin-top: 10px; font-weight: bold; min-height: 30px; }

    #next-btn {
      margin-top: 25px; padding: 12px 18px; font-size: 1.1em;
      border: none; border-radius: 8px;
      background: #ffd100; color: #111; font-weight: bold; cursor: pointer;
    }
    #next-btn:hover { background:#ffcc33; transform:scale(1.05); }

    input {
      padding: 10px; font-size: 1.1em; border-radius: 8px;
      border: 1px solid #ccc; width: 80%; margin-bottom: 10px;
    }

    button.start, button.continue-btn {
      margin-top: 10px; padding: 12px 20px; font-size: 1.1em;
      border-radius: 8px; border: none;
      background: #ffd100; color: #111; font-weight: bold; cursor: pointer;
    }
    button.start:hover, button.continue-btn:hover {
      background:#ffcc33; transform:scale(1.05);
    }

    #current-score {
      margin: 15px 0; font-size: 1.3em;
      color: #ffd100; font-weight: bold; display: none;
    }

    #explanation {
      display:none; background:rgba(255,255,255,0.08);
      padding:20px; margin-top:20px;
      border-radius:12px; max-width:600px; text-align:center;
    }

    #explanation .button-row {
      display:flex; justify-content:center; gap:12px; margin-top:20px;
    }

    .yellow-btn {
      background:#ffd100; color:#111;
      padding:14px 22px; font-size:1.1em;
      border-radius:10px; border:none; font-weight:bold; cursor:pointer;
    }
    .yellow-btn:hover { background:#ffcc33; transform:scale(1.05); }

    #timer {
      text-align: center;
      font-weight: 800;
      color: #ffeb3b;
      margin: 20px 0;
      font-size: clamp(1.8em, 5vw, 2.6em);
      text-shadow: 0 0 12px #ffcc00, 0 0 20px #ffcc00;
      letter-spacing: 1px;
    }

    #seconds {
      display: inline-block;
      min-width: 70px;
      text-align: center;
    }

    #ranking {
      margin-top: 25px;
      font-size: 0.95em;
      text-align: left;
    }

    #ranking h2 {
      font-size: 1.2em;
      margin-bottom: 10px;
      color: #ffd100;
    }

    #ranking ul {
      list-style: none;
      padding-left: 0;
    }

    #ranking li {
      margin-bottom: 4px;
    }

    #already-played-msg {
      margin-top: 15px;
      color: #ffb3b3;
      font-weight: bold;
    }
  </style>
</head>

<body>

<h1>–ò–≥—Ä–∏ –Ω–∞ –ó–Ω–∞–Ω–∏—è<br>üçπ –ö—É–∏–∑ –ö–æ–∫—Ç–µ–π–ª 5 üçπ</h1>

<div id="start-screen">
  <p>–í—ä–≤–µ–¥–µ—Ç–µ –í–∞—à–µ—Ç–æ ID:</p>

  <input type="text" id="player-id" placeholder="ID ..." /><br>

  <button class="start" id="start-btn">–ó–∞–ø–æ—á–Ω–∏!</button><br>

  <button class="continue-btn" id="continue-btn" style="display:none;">
    –ü—Ä–æ–¥—ä–ª–∂–∏ –æ—Ç –º—è—Å—Ç–æ—Ç–æ, –∫—ä–¥–µ—Ç–æ —Å–ø—Ä—è—Ö—Ç–µ
  </button>

  <div id="last-result" style="margin-top:15px;"></div>
  <div id="already-played-msg"></div>

  <div id="ranking"></div>
</div>

<div id="quiz" style="display:none;">
  <div id="timer">
    <span class="label">–û—Å—Ç–∞–≤–∞—â–æ –≤—Ä–µ–º–µ:</span>
    <span id="seconds">20 —Å–µ–∫.</span>
  </div>
  <div id="question"></div>
  <div id="answers" class="answers"></div>
  <div id="status"></div>
  <button id="next-btn" disabled>–°–ª–µ–¥–≤–∞—â –≤—ä–ø—Ä–æ—Å</button>
  <div id="current-score"></div>
</div>

<div id="explanation">
  <div id="explanation-text" style="font-size:1.2em; margin-bottom:20px;"></div>

  <div class="button-row">
    <button id="next-question-btn" class="yellow-btn">–°–ª–µ–¥–≤–∞—â –≤—ä–ø—Ä–æ—Å</button>
    <button id="close-explanation-btn" class="yellow-btn">–ó–∞—Ç–≤–æ—Ä–∏</button>
  </div>
</div>
<script src="players.js"></script>
  <script>
console.log("–¢–ï–°–¢: players.js —Å–µ –∑–∞—Ä–µ–∂–¥–∞ –ª–∏?");
console.log("PLAYERS:", typeof PLAYERS);
</script>

<script>
(async function(){

  // ===== –ù–ê–°–¢–†–û–ô–ö–ò –ù–ê –ò–ì–†–ê–¢–ê =====

  const AREA_DISTRIBUTION = {
    "–ì–µ–æ–≥—Ä–∞—Ñ–∏—è": 3,
    "–ò—Å—Ç–æ—Ä–∏—è": 3,
    "–§–∏–ª–æ—Å–æ—Ñ–∏—è": 2,
    "–ú–∏—Ç–æ–ª–æ–≥–∏—è": 2,
    "–†–µ–ª–∏–≥–∏—è": 2,
    "–ò–∑–∫—É—Å—Ç–≤–æ": 2,
    "–ö—É–ª–∏–Ω–∞—Ä–∏—è": 3,
    "–ö–∏–Ω–æ": 3,
    "–õ–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞": 3,
    "–ú—É–∑–∏–∫–∞": 3,
    "–ù–∞—É–∫–∞": 3,
    "–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞": 3,
    "–ê—Å—Ç—Ä–æ–Ω–æ–º–∏—è": 3,
    "–ë–∏–æ–ª–æ–≥–∏—è": 3,
    "–§–∏–∑–∏–∫–∞": 3,
    "–•–∏–º–∏—è": 3,
    "–°–ø–æ—Ä—Ç": 3,
    "–§—É—Ç–±–æ–ª": 3
  };

  const TOTAL_QUESTIONS = 50;

  // ===== DOM –ï–õ–ï–ú–ï–ù–¢–ò =====

  const startScreen = document.getElementById('start-screen');
  const playerIdInput = document.getElementById('player-id');
  const startBtn = document.getElementById('start-btn');
  const continueBtn = document.getElementById('continue-btn');
  const lastResultDiv = document.getElementById('last-result');
  const alreadyPlayedMsg = document.getElementById('already-played-msg');
  const rankingDiv = document.getElementById('ranking');

  const qText = document.getElementById('question');
  const answersDiv = document.getElementById('answers');
  const nextBtn = document.getElementById('next-btn');
  const status = document.getElementById('status');
  const timerDisplay = document.getElementById('timer');
  const currentScoreDiv = document.getElementById('current-score');

  const quizDiv = document.getElementById('quiz');
  const explanationDiv = document.getElementById('explanation');
  const explanationText = document.getElementById('explanation-text');

  // ===== –°–™–°–¢–û–Ø–ù–ò–ï –ù–ê –ò–ì–†–ê–¢–ê =====

 
  let ALL_QUESTIONS = [];
  let questions = [];
  let playerId = '';
  let playerName = '';
  let idx = 0;
  let score = 0;
  let timeLeft = 20;
  let timer;
  let gameHistory = [];
  let alreadyPlayedToday = false; // —â–µ —Å–µ –∑–∞–¥–∞–≤–∞ –æ—Ç Firebase –±–ª–æ–∫–∞

  // ===== –ü–û–ú–û–©–ù–ò –§–£–ù–ö–¶–ò–ò =====

  function normalize(s){ return String(s).trim(); }

  function shuffleArray(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  function lockAnswers() {
    Array.from(answersDiv.children).forEach(b => b.disabled = true);
  }

  function startTimer() {
    clearInterval(timer);
    timeLeft = 20;
    document.getElementById("seconds").textContent = `${timeLeft} —Å–µ–∫.`;
    timerDisplay.classList.remove("warning");

    timer = setInterval(() => {
      timeLeft--;
      document.getElementById("seconds").textContent = `${timeLeft} —Å–µ–∫.`;
      if (timeLeft <= 5) timerDisplay.classList.add("warning");

      if (timeLeft <= 0) {
        clearInterval(timer);
        lockAnswers();
        status.textContent = "‚è∞ –í—Ä–µ–º–µ—Ç–æ –∏–∑—Ç–µ—á–µ!";
        nextBtn.disabled = false;
      }
    }, 1000);
  }

  function showHistoryScreen() {
    quizDiv.style.display = "none";
    explanationDiv.style.display = "none";
    startScreen.style.display = "none";

    let historyDiv = document.getElementById("history-screen");
    if (!historyDiv) {
      historyDiv = document.createElement("div");
      historyDiv.id = "history-screen";
      historyDiv.style.padding = "20px";
      historyDiv.style.maxWidth = "600px";
      historyDiv.style.marginTop = "20px";
      historyDiv.style.background = "rgba(255,255,255,0.08)";
      historyDiv.style.borderRadius = "12px";
      historyDiv.style.textAlign = "left";

      document.body.appendChild(historyDiv);
    }

    historyDiv.innerHTML = "<h2>üìò –ò—Å—Ç–æ—Ä–∏—è –Ω–∞ –∏–≥—Ä–∞—Ç–∞</h2><br>";

    gameHistory.forEach((h, i) => {
      historyDiv.innerHTML += `
        <div style="margin-bottom:20px; padding-bottom:10px; border-bottom:1px solid #444;">
          <b>${i+1}. ${h.question}</b><br><br>
          –¢–≤–æ—è—Ç –æ—Ç–≥–æ–≤–æ—Ä: <span style="color:${h.correct?'#2ecc71':'#e74c3c'}">${h.yourAnswer}</span><br>
          –í–µ—Ä–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä: <b style="color:#2ecc71">${h.correctAnswer}</b><br>
          <div style="margin-top:10px;color:#ddd"><i>${h.explanation}</i></div>
        </div>
      `;
    });

    historyDiv.innerHTML += `
      <button id="retry2-btn" class="yellow-btn" style="margin-top:20px;">–û–ø–∏—Ç–∞–π –ø–∞–∫</button>
    `;

    document.getElementById("retry2-btn").onclick = onRetryClicked;
  }

  function restartGameHard() {
    localStorage.removeItem("quiz_cocktail_progress");
    location.reload();
  }

  function onRetryClicked() {
    // –¢–£–ö –ï –õ–û–ì–ò–ö–ê–¢–ê "–û–ü–ò–¢–ê–ô –ü–ê–ö" ‚Üí "–í–µ—á–µ —Å–∏ –∏–≥—Ä–∞–ª –¥–Ω–µ—Å"
    // –ê–∫–æ Firebase –±–ª–æ–∫—ä—Ç –µ –º–∞—Ä–∫–∏—Ä–∞–ª alreadyPlayedToday = true,
    // –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑–≤–∞–º–µ —Å—ä–æ–±—â–µ–Ω–∏–µ.
    alreadyPlayedMsg.textContent = "–í–µ—á–µ —Å–∏ –∏–≥—Ä–∞–ª –¥–Ω–µ—Å.";
  }

  // ===== –ó–ê–†–ï–ñ–î–ê–ù–ï –ù–ê –î–ê–ù–ù–ò =====

  
  try {
    const res = await fetch('questions.json');
    ALL_QUESTIONS = await res.json();
  } catch(e) {
    qText.textContent = "–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –≤—ä–ø—Ä–æ—Å–∏—Ç–µ.";
    return;
  }

  // –ü–æ—Å–ª–µ–¥–µ–Ω —Ä–µ–∑—É–ª—Ç–∞—Ç (–ª–æ–∫–∞–ª–Ω–æ, –∑–∞ —É–¥–æ–±—Å—Ç–≤–æ)
  const last = JSON.parse(localStorage.getItem('quiz_cocktail_lastResult'));
  if (last) {
    lastResultDiv.innerHTML =
      `<b>–ü–æ—Å–ª–µ–¥–µ–Ω —Ä–µ–∑—É–ª—Ç–∞—Ç:</b><br>${last.name} ‚Äî ${last.score}/${last.total} (${last.percent}%)<br>
       <small>${last.date}</small>`;
  }

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞ –ª–æ–∫–∞–ª–µ–Ω –ø—Ä–æ–≥—Ä–µ—Å (–∑–∞ "–ü—Ä–æ–¥—ä–ª–∂–∏")
  const saved = JSON.parse(localStorage.getItem('quiz_cocktail_progress'));
  if (saved && saved.idx < saved.total && saved.playerId) {
    continueBtn.style.display = "inline-block";
    continueBtn.textContent = `–ü—Ä–æ–¥—ä–ª–∂–∏ –æ—Ç –≤—ä–ø—Ä–æ—Å ${saved.idx + 1}`;
  }

  // ===== –ò–ó–ë–û–† –ù–ê –í–™–ü–†–û–°–ò –ü–û –û–ë–õ–ê–°–¢–ò =====

  function buildQuestionsForGame() {
    let selected = [];

    for (const area in AREA_DISTRIBUTION) {
      const needed = AREA_DISTRIBUTION[area] || 0;
      if (needed <= 0) continue;

      const pool = ALL_QUESTIONS.filter(q => q.area === area);
      const shuffled = shuffleArray([...pool]);
      const taken = shuffled.slice(0, needed);
      selected = selected.concat(taken);
    }

    // –ê–∫–æ –ø–æ –Ω—è–∫–∞–∫–≤–∞ –ø—Ä–∏—á–∏–Ω–∞ —Å–∞ –ø–æ–≤–µ—á–µ –æ—Ç 50, —Ä–µ–∂–µ–º –¥–æ 50
    if (selected.length > TOTAL_QUESTIONS) {
      selected = selected.slice(0, TOTAL_QUESTIONS);
    }

    // –°–æ—Ä—Ç–∏—Ä–∞–Ω–µ –ø–æ —Ç—Ä—É–¥–Ω–æ—Å—Ç: –æ—Ç –Ω–∞–π-–ª–µ—Å–µ–Ω (100) –∫—ä–º –Ω–∞–π-—Ç—Ä—É–¥–µ–Ω (–º–∞–ª–∫–æ —á–∏—Å–ª–æ)
    selected.sort((a, b) => b.hard - a.hard);

    return selected;
  }

  // ===== –†–ï–ù–î–ï–† –ù–ê –í–™–ü–†–û–° =====

  function renderQuestion(i) {
    const q = questions[i];

    qText.textContent = `${i+1}. ${q.question}`;
    answersDiv.innerHTML = "";
    status.textContent = "";
    nextBtn.disabled = true;
    explanationDiv.style.display = "none";

    currentScoreDiv.style.display = "none";

    const shuffledAnswers = shuffleArray([...q.answers]);

    shuffledAnswers.forEach(ans => {
      const btn = document.createElement("button");
      btn.textContent = ans;

      btn.onclick = () => {
        lockAnswers();
        clearInterval(timer);

        const correct = normalize(q.correct);
        const chosen = normalize(ans);

        if (chosen === correct) {
          btn.classList.add("correct");
          status.textContent = "‚úÖ –í–µ—Ä–µ–Ω –æ—Ç–≥–æ–≤–æ—Ä!";
          score++;
        } else {
          btn.classList.add("wrong");
          status.textContent = `‚ùå –ì—Ä–µ—à–Ω–æ! –í–µ—Ä–Ω–∏—è—Ç –æ—Ç–≥–æ–≤–æ—Ä –µ: ${q.correct}`;
          Array.from(answersDiv.children).forEach(b => {
            if (normalize(b.textContent) === correct) b.classList.add("correct");
          });
        }

        gameHistory.push({
          question: q.question,
          yourAnswer: ans,
          correctAnswer: q.correct,
          correct: chosen === correct,
          explanation: q.explanation
        });

        currentScoreDiv.textContent = `–¢–µ–∫—É—â —Ä–µ–∑—É–ª—Ç–∞—Ç: ${score} —Ç–æ—á–∫–∏`;
        currentScoreDiv.style.display = "block";

        explanationText.innerHTML = q.explanation;
        explanationDiv.style.display = "block";

        nextBtn.disabled = false;

        localStorage.setItem("quiz_cocktail_progress", JSON.stringify({
          playerId,
          name: playerName,
          idx: i,
          score,
          total: questions.length
        }));
      };

      answersDiv.appendChild(btn);
    });

    startTimer();
  }

  // ===== –°–¢–ê–†–¢ –ò –ü–†–û–î–™–õ–ñ–ê–í–ê–ù–ï =====

  continueBtn.onclick = () => {
    if (!saved) return;
    playerId = saved.playerId;
    playerName = saved.name || PLAYERS[playerId] || playerId;

    // –¢—É–∫ –º–æ–∂–µ –¥–∞ —Å–µ –Ω–∞–ø—Ä–∞–≤–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å Firebase –¥–∞–ª–∏ –≤–µ—á–µ –µ –∏–≥—Ä–∞–ª –¥–Ω–µ—Å.
    // –ê–∫–æ alreadyPlayedToday = true ‚Üí –±–ª–æ–∫–∏—Ä–∞–º–µ.
    if (alreadyPlayedToday) {
      alreadyPlayedMsg.textContent = "–î–Ω–µ—Å –≤–µ—á–µ —Å–∏ –∏–≥—Ä–∞–ª.";
      return;
    }

    questions = buildQuestionsForGame();

    idx = saved.idx;
    score = saved.score;

    startScreen.style.display = "none";
    quizDiv.style.display = "block";
    renderQuestion(idx);
  };

  startBtn.onclick = async () => {
    const id = playerIdInput.value.trim();
    if (!id) {
      alert("–í—ä–≤–µ–¥–µ—Ç–µ ID!");
      return;
    }

    if (!PLAYERS[id]) {
      alert("–ù–µ–≤–∞–ª–∏–¥–Ω–æ ID!");
      return;
    }

    playerId = id;
    playerName = PLAYERS[id];

    // –¢–£–ö –©–ï –í–õ–ï–ó–ï –ü–†–û–í–ï–†–ö–ê–¢–ê –° FIREBASE –î–ê–õ–ò –í–ï–ß–ï –ï –ò–ì–†–ê–õ –î–ù–ï–°.
    // Firebase –±–ª–æ–∫—ä—Ç —â–µ –∑–∞–¥–∞–≤–∞ alreadyPlayedToday = true/false
    // –∏ —â–µ –º–æ–∂–µ –¥–∞ –≤—ä—Ä–Ω–µ –∏ –∫–ª–∞—Å–∏—Ä–∞–Ω–µ—Ç–æ –∑–∞ –¥–µ–Ω—è.
    // –ê–∫–æ alreadyPlayedToday –µ true ‚Üí –ø–æ–∫–∞–∑–≤–∞–º–µ —Å—ä–æ–±—â–µ–Ω–∏–µ –∏ —Å–ø–∏—Ä–∞–º–µ.
    if (alreadyPlayedToday) {
      alreadyPlayedMsg.textContent = "–î–Ω–µ—Å –≤–µ—á–µ —Å–∏ –∏–≥—Ä–∞–ª.";
      return;
    }

    localStorage.removeItem("quiz_cocktail_progress");

    questions = buildQuestionsForGame();
    idx = 0;
    score = 0;
    gameHistory = [];

    startScreen.style.display = "none";
    quizDiv.style.display = "block";

    renderQuestion(0);
  };

  // ===== –ù–ê–í–ò–ì–ê–¶–ò–Ø –ú–ï–ñ–î–£ –í–™–ü–†–û–°–ò–¢–ï =====

  nextBtn.onclick = nextQuestionFromExplanation;
  document.getElementById("next-question-btn").onclick = nextQuestionFromExplanation;

  function nextQuestionFromExplanation() {
    explanationDiv.style.display = "none";
    idx++;

    if (idx >= questions.length) return finishGame();

    renderQuestion(idx);
  }

  function finishGame() {
    clearInterval(timer);

    const percent = Math.round(score / questions.length * 100);

    submitResultToFirebase({
  playerId,
  playerName,
  score,
  total: questions.length,
  percent
});


    qText.innerHTML =
      `üèÅ –ö—Ä–∞–π –Ω–∞ –∏–≥—Ä–∞—Ç–∞, <b>${playerName}</b>!<br><br>
      –†–µ–∑—É–ª—Ç–∞—Ç: <b>${score}</b> –æ—Ç <b>${questions.length}</b> (${percent}%).<br><br>`;

    answersDiv.innerHTML = "";
    nextBtn.disabled = true;
    timerDisplay.textContent = "";
    currentScoreDiv.style.display = "none";

    localStorage.setItem("quiz_cocktail_lastResult", JSON.stringify({
      playerId,
      name: playerName,
      score,
      total: questions.length,
      percent,
      date: new Date().toLocaleString('bg-BG')
    }));

    localStorage.removeItem("quiz_cocktail_progress");

    qText.innerHTML += `
      <div style="display:flex; justify-content:center; gap:12px; margin-top:20px;">
        <button id="history-btn" class="yellow-btn">–ò—Å—Ç–æ—Ä–∏—è –Ω–∞ –∏–≥—Ä–∞—Ç–∞</button>
        <button id="retry-btn" class="yellow-btn">–û–ø–∏—Ç–∞–π –ø–∞–∫</button>
      </div>
    `;

    document.getElementById("history-btn").onclick = showHistoryScreen;
    document.getElementById("retry-btn").onclick = onRetryClicked;

    // –¢–£–ö –©–ï –°–ï –ò–ó–í–ò–ö–ê –§–£–ù–ö–¶–ò–Ø–¢–ê –ó–ê –ó–ê–ü–ò–° –í FIREBASE (–∫–ª–∞—Å–∏—Ä–∞–Ω–µ + –∞—Ä—Ö–∏–≤)
    // –Ω–∞–ø—Ä–∏–º–µ—Ä: submitResultToFirebase({ playerId, playerName, score, total: questions.length, percent });
  }

  document.getElementById("close-explanation-btn").onclick = () => {
    explanationDiv.style.display = "none";
  };

  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { 
  getFirestore, doc, setDoc, getDoc,
  collection, query, orderBy, onSnapshot
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyB6ds9mU-xvF1LSvhaeCNtMbROu0k",
  authDomain: "cifromania-ac182.firebaseapp.com",
  projectId: "cifromania-ac182",
  storageBucket: "cifromania-ac182.appspot.com",
  messagingSenderId: "165208255580",
  appId: "1:165208255580:web:b36744f0eb527b6571129"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

function todayKey() {
  return new Date().toISOString().slice(0, 10);
}

async function checkAlreadyPlayedToday(playerId) {
  const ref = doc(db, "games", "kokteil", "results", todayKey(), "players", playerId);
  const snap = await getDoc(ref);

  if (snap.exists()) {
    alreadyPlayedToday = true;
    alreadyPlayedMsg.textContent = "–î–Ω–µ—Å –≤–µ—á–µ —Å—Ç–µ –∏–≥—Ä–∞–ª–∏.";
    startBtn.disabled = true;
    continueBtn.style.display = "none";
    return true;
  }

  alreadyPlayedToday = false;
  return false;
}

function loadRanking() {
  const col = collection(db, "games", "kokteil", "results", todayKey(), "players");
  const q = query(col, orderBy("percent", "desc"));

  onSnapshot(q, (snap) => {
    let html = `<h2>–ö–ª–∞—Å–∏—Ä–∞–Ω–µ –∑–∞ –¥–Ω–µ—Å (${todayKey()})</h2><ul>`;
    snap.forEach(doc => {
      const d = doc.data();
      html += `<li><b>${d.playerName}</b>: ${d.percent}% (${d.score}/${d.total})</li>`;
    });
    html += "</ul>";
    rankingDiv.innerHTML = html;
  });
}

async function submitResultToFirebase({ playerId, playerName, score, total, percent }) {
  const resultRef = doc(db, "games", "kokteil", "results", todayKey(), "players", playerId);
  await setDoc(resultRef, {
    playerId, playerName, score, total, percent, timestamp: Date.now()
  });

  const archiveRef = doc(db, "games", "kokteil", "archive", playerId);
  await setDoc(archiveRef, {
    [todayKey()]: { score, total, percent }
  }, { merge: true });
}

startBtn.addEventListener("click", async () => {
  const id = playerIdInput.value.trim();
  if (!id) return;
  await checkAlreadyPlayedToday(id);
});

loadRanking();


})();
</script>

</body>
</html>
